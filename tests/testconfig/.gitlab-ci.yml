--- #-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# Define global variables for all jobs
variables:
    # Clone repository by default, file have changed attribute.
    GIT_STRATEGY: clone
    # If not called by a scheduler this variable has to be 0.
    # 1: daily full
    # 2: daily debug
    # 3: weekly coverage
    GITLAB_SCHEDULER_TYPE: "0"

    # Build type for pipelines started via the GitLab GUI
    # Options:
    # - "release" (default)
    # - "debug"
    CTEST_BUILD_TYPE_GITLAB: "release"

    # Prefix for do-configure.
    CTEST_CONFIGURE_PREFIX: ""

    # Postfix for do-configure.
    CTEST_CONFIGURE_POSTFIX: ""

    # Select specific test by regular expressen (".": all)
    TEST_TAG: "."

    # Temporary exclude postprocessing tests at IMCS.
    CTEST_EXCLUDE_STRING: ""

    # Flag to specify if pipeline fails on warning (0:no, 1:yes)
    CTEST_FAIL_ON_WARNING: "1"

    # Flags for additional pipelines (daily full) performed only if set (used of the clusters) (0:no, 1:yes)
    GITLAB_SCHEDULER_LNM_SCHMARRN: "0"
    GITLAB_SCHEDULER_LNM_DEEP: "0"
    GITLAB_SCHEDULER_LNM_BRUTEFORCE: "0"

    # Flags for entering interactive mode on specific machines # (0: off, 1: on)
    GITLAB_INTERACTIVE_MODE: "0"
    # Flag for the machine to start interactive session (none, lnm_workstation, lnm_bruteforce_icc, lnm_bruteforce_gcc, lnm_deep, lnm_schmarrn, imcs)
    GITLAB_INTERACTIVE_MACHINE: "none"
    # Flags for doing a clean build in interactive mode # (0: off, 1: on)
    GITLAB_INTERACTIVE_CLEAN: "0"

#-------------------------------------------------------------------------------
# Define the base jobs for testing
#-------------------------------------------------------------------------------

# This kind of job is started when something changes in the master branch.
# Minimal tests are performed.
.buildtest_minimal: &buildtest_minimal
    stage: buildtest
    variables:
        # So the old build can be used again.
        GIT_STRATEGY: fetch
    script:
        - "echo minimal test: triggered by change in master"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Clear eventual ccache cache.
        - 'if [ -x "$(command -v ccache)" ]; then ccache -C -z; echo "ccache cache cleared"; fi'
        - ctest -S $CI_PROJECT_DIR/tests/testconfig/test_release.cmake -VV -L minimal | tee ../buildtest_minimal.log | grep -e "^MakeCommand" -e "^\[" -e "^\[" -e "Compiler " -e "\*\*\*Failed" -e "\.\.\.   Passed" -e " tests passed\,"
    after_script:
        # Move the log file to the source folder, so it can be found by artifacts.
        - mv ../buildtest_minimal.log buildtest_minimal.log
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - buildtest_minimal.log
        when: on_failure
        expire_in: 5 days
    only:
        - master
    except:
        refs:
            - schedules
            - web
        variables:
            - $GITLAB_SCHEDULER_TYPE == "1"
            - $GITLAB_SCHEDULER_TYPE == "2"
            - $GITLAB_SCHEDULER_TYPE == "3"

# This kind of job is started when a user triggers a job in the gitlab UI.
# Full tests are performed.
.buildtest_full: &buildtest_full
    stage: buildtest
    script:
        # Specify which configuration is tested by this pipeline
        - "echo Baci build type: $CTEST_BUILD_TYPE_GITLAB"
        - "echo Run tests matching expression: $TEST_TAG [{.} all tests, {} no test]"
        - "echo Excluded tests: $CTEST_EXCLUDE_STRING [{} no test excluded]"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Clear eventual ccache cache.
        - 'if [ -x "$(command -v ccache)" ]; then ccache -C -z; echo "ccache cache cleared"; fi'
        # Output to log because it is too much for the gitlab console.
        - 'ctest -S $CI_PROJECT_DIR/tests/testconfig/test_${CTEST_BUILD_TYPE_GITLAB}.cmake -VV -E "$CTEST_EXCLUDE_STRING" -R "$TEST_TAG" | tee ../buildtest_full.log | grep -e "^MakeCommand" -e "^\[" -e "^\[" -e "Compiler " -e "\*\*\*Failed" -e "\.\.\.   Passed" -e " tests passed\," '
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        # Output 200 lines for any failing test
        - grep -B 200 '*Failed\|*Timeout' ../buildtest_full.log || true
        - sed -n '/tests passed,/,//p' ../buildtest_full.log
        # Specify which configuration was tested by this pipeline
        - "echo Baci build type: $CTEST_BUILD_TYPE_GITLAB"
        - "echo Run tests matching expression: $TEST_TAG [{.} all tests, {} no test]"
        - "echo Excluded tests: $CTEST_EXCLUDE_STRING [{} no test excluded]"
        # Move the log file to the source folder, so it can be found by artifacts.
        - mv ../buildtest_full.log buildtest_full.log
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - buildtest_full.log
        when: on_failure
        expire_in: 5 days
    only:
        refs:
            - web
    except:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "1"
            - $GITLAB_SCHEDULER_TYPE == "2"
            - $GITLAB_SCHEDULER_TYPE == "3"
            - $GITLAB_INTERACTIVE_MODE == "1"

# This kind of job is started when a user triggers a job in the Gitlab UI and sets the interactive flag GITLAB_INTERACTIVE_MODE to 1
.buildtest_interactive: &buildtest_interactive
    stage: buildtest
    script:
        # Specify which configuration is tested by this pipeline
        - "echo Baci build type: $CTEST_BUILD_TYPE_GITLAB"
        - "echo Run tests matching expression: $TEST_TAG [{.} all tests, {} no test]"
        - "echo Excluded tests: $CTEST_EXCLUDE_STRING [{} no test excluded]"
        # clear cache only if specified
        - 'if [ "$GITLAB_INTERACTIVE_CLEAN" == "1" ]; then'
        - "echo Cleaning old build files"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Clear eventual ccache cache.
        - 'if [ -x "$(command -v ccache)" ]; then ccache -C -z; echo "ccache cache cleared"; fi'
        - "fi"
        # Output to log because it is too much for the gitlab console.
        - 'ctest -S $CI_PROJECT_DIR/tests/testconfig/test_${CTEST_BUILD_TYPE_GITLAB}.cmake -VV -E "$CTEST_EXCLUDE_STRING" -R "$TEST_TAG" | tee ../buildtest_interactive.log | grep -e "^MakeCommand" -e "^\[" -e "^\[" -e "Compiler " -e "\*\*\*Failed" -e "\.\.\.   Passed" -e " tests passed\," '
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        # Output 200 lines for any failing test
        - grep -B 200 '*Failed\|*Timeout' ../buildtest_interactive.log || true
        - sed -n '/tests passed,/,//p' ../buildtest_interactive.log
        # Specify which configuration was tested by this pipeline
        - "echo Baci build type: $CTEST_BUILD_TYPE_GITLAB"
        - "echo Run tests matching expression: $TEST_TAG [{.} all tests, {} no test]"
        - "echo Excluded tests: $CTEST_EXCLUDE_STRING [{} no test excluded]"
        # Move the log file to the source folder, so it can be found by artifacts.
        - mv ../buildtest_interactive.log buildtest_interactive.log
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - buildtest_interactive.log
        expire_in: 5 days

# This kind of job is started by a weekly scheduler, with the variable
# $GITLAB_SCHEDULER_TYPE = "3"
# Full tests with coverage are performed
# A coverage report is created
.buildtest_coverage_weekly: &buildtest_coverage_weekly
    stage: buildtest
    script:
        # Specify which configuration is tested by this pipeline
        - "echo Baci build type: $CTEST_BUILD_TYPE_GITLAB"
        - "echo Run tests matching expression: $TEST_TAG [{.} all tests, {} no test]"
        - "echo Excluded tests: $CTEST_EXCLUDE_STRING [{} no test excluded]"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Clear eventual ccache cache.
        - 'if [ -x "$(command -v ccache)" ]; then ccache -C -z; echo "ccache cache cleared"; fi'
        # Output to log because it is too much for the gitlab console.
        - 'ctest -S $CI_PROJECT_DIR/tests/testconfig/test_release.cmake -VV -E "$CTEST_EXCLUDE_STRING" -R "$TEST_TAG" | tee buildtest_weekly_coverage.log | grep -e "^MakeCommand" -e "^\[" -e "^\[" -e "Compiler " -e "\*\*\*Failed" -e "\.\.\.   Passed" -e " tests passed\," '
    after_script:
        # generate the baci_coverage_base.info: the "baseline" coverage data file that contains zero coverage for every instrumented line.
        - lcov --capture --initial --no-external --directory ../baci-build/ --base-directory . --output-file baci_coverage_base.info > baci_coverage_base.log
        # generate the baci_coverage_tests.info based on tests run above
        - lcov --capture --no-external --directory ../baci-build/ --base-directory . --output-file baci_coverage_tests.info > baci_coverage_tests.log
        # combine the baseline coverage with the coverage from the tests
        - lcov --add-tracefile baci_coverage_base.info --add-tracefile baci_coverage_tests.info --output-file baci_coverage.info  > baci_coverage.log
        # generate the html version of the coverage report
        - genhtml baci_coverage.info --legend --demangle-cpp --output-directory coverage_report/ --title "BACI commit $CI_COMMIT_SHORT_SHA" | tee genhtml_weekly_coverage.log
        # add repo link to the commit that the report is based on
        - find coverage_report/ -type f -exec sed -i "s/BACI commit $CI_COMMIT_SHORT_SHA/BACI commit  \<a href=\"https:\/\/gitlab.lrz.de\/baci\/baci\/commit\/$CI_COMMIT_SHA\"\>$CI_COMMIT_SHORT_SHA\<\/a\>/g" {} \;
        # Write Selection of the output into the terminal and therefore to GITLAB
        # Output 200 lines for any failing test
        - grep -B 200 '*Failed\|*Timeout' buildtest_weekly_coverage.log || true
        - sed -n '/tests passed,/,//p' buildtest_weekly_coverage.log
        # Specify which configuration was tested by this pipeline
        - "echo Baci build type: $CTEST_BUILD_TYPE_GITLAB"
        - "echo Run tests matching expression: $TEST_TAG [{.} all tests, {} no test]"
        - "echo Excluded tests: $CTEST_EXCLUDE_STRING [{} no test excluded]"
    # we allow this job to fail since we care more about execution of all tests then passing all tests
    # passing tests are checked in daily pipelines while here we would like to measure the code covered by the tests
    allow_failure: true
    # update (push) the cache of the weekly coverage report:
    # cache can be used to pass data between pipelines (in contrast to artifacts that pass data from stage to stage in a
    # single pipeline)
    cache:
        key: cache-weekly-coverage-report
        paths:
            - coverage_report/
            # the log is needed to print the weekly value of total line coverage in daily and minimal master pipelines
            - genhtml_weekly_coverage.log
        policy: push
    # store the coverage report in an artifact so that the subsequent (obligatory) pages job can find it
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - baci_coverage_base.info
            - baci_coverage_base.log
            - baci_coverage_tests.info
            - baci_coverage_tests.log
            - baci_coverage.info
            - baci_coverage.log
            - buildtest_weekly_coverage.log
            - genhtml_weekly_coverage.log
            - coverage_report/
        # upload .log on_failure and coverage_report/ on_success:
        # currently there is no option to have multiple artifacts with different when: options
        # -> always upload artifacts of this job
        when: always
        expire_in: 5 days
    only:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "3"

# This kind of job is started by a daily scheduler, with the variable
# $GITLAB_SCHEDULER_TYPE = "1"
# Full tests are performed.
.buildtest_daily: &buildtest_daily
    stage: buildtest
    script:
        # Specify which configuration is tested by this pipeline
        - "echo Nightly Test Release"
        - "echo Baci build type: $CTEST_BUILD_TYPE_GITLAB"
        - "echo Run tests matching expression: $TEST_TAG [{.} all tests, {} no test]"
        - "echo Excluded tests: $CTEST_EXCLUDE_STRING [{} no test excluded]"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Clear eventual ccache cache.
        - 'if [ -x "$(command -v ccache)" ]; then ccache -C -z; echo "ccache cache cleared"; fi'
        # Output to log because it is too much for the gitlab console.
        - 'ctest -S $CI_PROJECT_DIR/tests/testconfig/test_release.cmake -VV -E "$CTEST_EXCLUDE_STRING" -R "$TEST_TAG" | tee ../buildtest_daily.log | grep -e "^MakeCommand" -e "^\[" -e "^\[" -e "Compiler " -e "\*\*\*Failed" -e "\.\.\.   Passed" -e " tests passed\,"'
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        # Output 200 lines for any failing test
        - grep -B 200 '*Failed\|*Timeout' ../buildtest_daily.log || true
        - sed -n '/tests passed,/,//p' ../buildtest_daily.log
        # Specify which configuration was tested by this pipeline
        - "echo Baci build type: $CTEST_BUILD_TYPE_GITLAB"
        - "echo Run tests matching expression: $TEST_TAG [{.} all tests, {} no test]"
        - "echo Excluded tests: $CTEST_EXCLUDE_STRING [{} no test excluded]"
        # Move the log file to the source folder, so it can be found by artifacts.
        - mv ../buildtest_daily.log buildtest_daily.log
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - buildtest_daily.log
        when: on_failure
        expire_in: 5 days
    only:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "1"

# This kind of job is started by a daily scheduler, with the variable
# $GITLAB_SCHEDULER_TYPE = "2"
# Debug tests are performed.
.buildtest_daily_debug: &buildtest_daily_debug
    stage: buildtest
    script:
        # Specify which configuration is tested by this pipeline
        - "echo Nightly Test Debug"
        - "echo Baci build type: $CTEST_BUILD_TYPE_GITLAB"
        - "echo Run tests matching expression: $TEST_TAG [{.} all tests, {} no test]"
        - "echo Excluded tests: $CTEST_EXCLUDE_STRING [{} no test excluded]"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Clear eventual ccache cache.
        - 'if [ -x "$(command -v ccache)" ]; then ccache -C -z; echo "ccache cache cleared"; fi'
        # Output to log because it is too much for the gitlab console.
        - 'ctest -S $CI_PROJECT_DIR/tests/testconfig/test_debug.cmake -VV -E "$CTEST_EXCLUDE_STRING" | tee ../buildtest_daily_debug.log | grep -e "^MakeCommand" -e "^\[" -e "^\[" -e "Compiler " -e "\*\*\*Failed" -e "\.\.\.   Passed" -e " tests passed\,"'
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        # Output 200 lines for any failing test
        - grep -B 200 '*Failed\|*Timeout' ../buildtest_daily_debug.log || true
        - sed -n '/tests passed,/,//p' ../buildtest_daily_debug.log
        # Specify which configuration was tested by this pipeline
        - "echo Baci build type: $CTEST_BUILD_TYPE_GITLAB"
        - "echo Run tests matching expression: $TEST_TAG [{.} all tests, {} no test]"
        - "echo Excluded tests: $CTEST_EXCLUDE_STRING [{} no test excluded]"
        # Move the log file to the source folder, so it can be found by artifacts.
        - mv ../buildtest_daily_debug.log buildtest_daily_debug.log
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - buildtest_daily_debug.log
        when: on_failure
        expire_in: 5 days
    only:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "2"

# This kind of job is started when a user triggers a job in the gitlab UI.
#
# The doxygen_web job is meant for merge request testing.
.doxygen_web: &doxygen_web
    stage: doxygen
    script:
        - "echo Doxygen"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Output to log because it is too much for the gitlab console.
        - "ctest -S $CI_PROJECT_DIR/tests/testconfig/test_doxygen.cmake -VV > ../doxygen.log"
        # Throw error if there are Latex errors in doxygen comments. Latex errors can be uniquely identified by a line starting with "! ".
        - if grep -qE '^! ' ../doxygen.log; then echo "Found at least one LaTeX error during doxygen build."; exit 1; else echo "Doxygen builds without LaTeX errors."; fi
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        - sed -n '/* Extra verbosity turned on/,/Test project /p' ../doxygen.log
        # Write information about possible Latex errors to terminal
        - if grep -qE '^! ' ../doxygen.log; then echo "Found at least one LaTeX error during doxygen build."; else echo "Doxygen builds without LaTeX errors."; fi
        # Move the log file to the source folder, so it can be found by artifacts.
        - mv ../doxygen.log doxygen.log
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - doxygen.log
        when: on_failure
        expire_in: 5 days
    only:
        refs:
            - web
    except:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "3"
            - $GITLAB_INTERACTIVE_MODE == "1"

# This kind of job is started by a daily scheduler, with the variable
# $GITLAB_SCHEDULER_TYPE = "1"
# Doxygen is build and moved to a folder with known path.
#
# The doxygen job is meant for nightly testing. It also provides doxygen output
# to be copied to $DOXYGEN_PATH.
.doxygen: &doxygen
    stage: doxygen
    script:
        - "echo Doxygen"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Output to log because it is too much for the gitlab console.
        - "ctest -S $CI_PROJECT_DIR/tests/testconfig/test_doxygen.cmake -VV > ../doxygen.log"
        # Throw error if there are Latex errors in doxygen comments. Latex errors can be uniquely identified by a line starting with "! ".
        - if grep -qE '^! ' ../doxygen.log; then echo "Found at least one LaTeX error during doxygen build."; exit 1; else echo "Doxygen builds without LaTeX errors."; fi
        # Copy final doxygen files to pre-defined location
        - "cp -r $CI_PROJECT_DIR/../baci-build/doc/html $DOXYGEN_PATH"
        # Move final doxygen into the base folder for the next stage
        - "cp -r $CI_PROJECT_DIR/../baci-build/doc/html $CI_PROJECT_DIR/doxygen"
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        - sed -n '/* Extra verbosity turned on/,/Test project /p' ../doxygen.log
        # Write information about possible Latex errors to terminal
        - if grep -qE '^! ' ../doxygen.log; then echo "Found at least one LaTeX error during doxygen build."; else echo "Doxygen builds without LaTeX errors."; fi
        # Move the log file to the source folder, so it can be found by artifacts.
        - mv ../doxygen.log doxygen.log
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - doxygen.log
            - doxygen/
        when: always
        expire_in: 1 day
    only:
        # Build doxygen only on master builds
        refs:
            - master

#-------------------------------------------------------------------------------
# Stages during testing.
#-------------------------------------------------------------------------------

stages:
    - checkcode
    - buildtest
    - doxygen
    - pages

#-------------------------------------------------------------------------------
# Actual jobs for testing.
#-------------------------------------------------------------------------------

# ALL---------------------------------------------------------------------------

checkcode:
    stage: checkcode
    script:
        - "echo code check"
        - cd ../baci
        - bash utilities/code_checks/check_format_and_header
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - wrong_clang_format.txt
            - wrong_headers.txt
        when: on_failure
        expire_in: 5 days
    only:
        - master
        - web
    except:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "2"
            - $GITLAB_SCHEDULER_TYPE == "3"
            - $GITLAB_INTERACTIVE_MODE == "1"
    tags:
        - all

# IMCS--------------------------------------------------------------------------

imcs-buildtest_minimal:
    <<: *buildtest_minimal
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "imcs-workstation-baci-Q1-2015-minimal-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "imcs_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - imcs-minimal

imcs-buildtest_full:
    <<: *buildtest_full
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "imcs-workstation-baci-Q1-2015-$TEST_TAG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "imcs_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - imcs-full

imcs-buildtest_interactive:
    <<: *buildtest_interactive
    variables:
        TEST_TAG: ""
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "imcs-workstation-interactive-baci-Q1-2015-$TEST_TAG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "imcs_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        GIT_STRATEGY: fetch
    tags:
        - imcs-interactive
    rules:
        - if: '$GITLAB_INTERACTIVE_MODE == "1" && $GITLAB_INTERACTIVE_MACHINE == "imcs"'
          when: always

imcs-buildtest_daily:
    <<: *buildtest_daily
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "imcs-workstation-baci-Q1-2015-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "imcs_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - imcs-nightly-full

imcs-buildtest_daily_debug:
    <<: *buildtest_daily_debug
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "imcs-workstation-baci-Q1-2015-DEBUG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "imcs_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - imcs-nightly-debug

.imcs-doxygen:
    <<: *doxygen
    variables:
        CTEST_OPTION_IMCS: "-E '-*pp*|-*energy*'"
        CTEST_MAKE: "make documentation"
        CTEST_BUILD_NAME_GITLAB: "Doxygen-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "imcs_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        # Path on testing machine where doxygen will be copied to.
        DOXYGEN_PATH: "TBD"
    tags:
        - imcs-nightly

# LNM---------------------------------------------------------------------------

lnm-buildtest_minimal:
    <<: *buildtest_minimal
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "LnM-Workstation-minimal-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-mastermod-minimal

lnm-buildtest_full:
    <<: *buildtest_full
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "LnM-Workstation-$TEST_TAG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-user-full

lnm-workstation-buildtest_interactive:
    <<: *buildtest_interactive
    variables:
        TEST_TAG: ""
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "LnM-Workstation-interactive-$TEST_TAG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        GIT_STRATEGY: fetch
    tags:
        - lnm-workstation-interactive
    rules:
        - if: '$GITLAB_INTERACTIVE_MODE == "1" && $GITLAB_INTERACTIVE_MACHINE == "lnm_workstation"'
          when: always

lnm-buildtest_coverage_weekly:
    <<: *buildtest_coverage_weekly
    variables:
        # increase the global test timeout
        GLOBAL_TEST_TIMEOUT: "4500"
        # increase the unit test timeout
        UNITTEST_TIMEOUT: "50"
        # enable coverage option of ctest
        CTEST_CONFIGURE_POSTFIX: "--coverage"
        CTEST_MAKE: "make full -j4"
        CTEST_BUILD_NAME_GITLAB: "LnM-Workstation-coverage-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-weekly-coverage

pages: # job name needs to be pages
    stage: pages
    variables:
        # stage operates exclusively on artifacts. No need for source code.
        GIT_STRATEGY: fetch
    # Download Doxygen from previous lnm-doxygen stage
    dependencies:
        - lnm-doxygen
    script:
        # print the weekly measured coverage rate
        - "echo 'Weekly measured'"
        - grep "Overall coverage rate:" -A 2 genhtml_weekly_coverage.log
        # Create directory that will be published
        - mkdir -p public
        # move weekly created coverage report to public folder (which is the path for GitLab Pages content)
        - mv coverage_report public/coverage_report
        # Move most recent doxygen to public folder
        - mv doxygen public/doxygen
        # Create python venv to create badges
        - python3 -m venv venv
        - . venv/bin/activate
        - pip install anybadge
        # Create doxygen badge
        - anybadge -l doxygen -v ok --color=green -f public/doxygen.svg
    cache:
        key: cache-weekly-coverage-report
        paths:
            - coverage_report/
            - genhtml_weekly_coverage.log
        policy: pull
    artifacts:
        # store the public path in artifact
        # this is needed since in a subsequent deploy stage (automatically generated by GitLab)
        # the content of the below artifact is published on GitLab Pages
        paths:
            - public
    only:
        refs:
            - master
    tags:
        - lnm-release-weekly-coverage

lnm-buildtest_daily:
    <<: *buildtest_daily
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "LnM-Workstation-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-nightly-full

lnm-buildtest_daily_bruteforce_icc:
    <<: *buildtest_daily
    variables:
        TEST_TAG: ""
        CTEST_FAIL_ON_WARNING: "0"
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015-BruteForce-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "bruteforce_Q12015_icc.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-nightly-build-bruteforce
    only:
        variables:
            - $GITLAB_SCHEDULER_LNM_BRUTEFORCE == "1"

lnm-buildtest_daily_bruteforce_gcc:
    <<: *buildtest_daily
    variables:
        TEST_TAG: ""
        CTEST_FAIL_ON_WARNING: "0"
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-BruteForce-GCC-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_bruteforce_gcc.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    before_script:
        - module load comp/gcc/5.3.0
    tags:
        - lnm-release-nightly-build-bruteforce
    only:
        variables:
            - $GITLAB_SCHEDULER_LNM_BRUTEFORCE == "1"

lnm-buildtest-bruteforce-icc_interactive:
    <<: *buildtest_interactive
    variables:
        TEST_TAG: ""
        CTEST_FAIL_ON_WARNING: "0"
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-interactive-baci-Q1-2015-BruteForce-icc-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "bruteforce_Q12015_icc.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        GIT_STRATEGY: fetch
    tags:
        - lnm-bruteforce-icc-interactive
    rules:
        - if: '$GITLAB_INTERACTIVE_MODE == "1" && $GITLAB_INTERACTIVE_MACHINE == "lnm_bruteforce_icc"'
          when: always

lnm-buildtest-bruteforce-gcc_interactive:
    <<: *buildtest_interactive
    variables:
        TEST_TAG: ""
        CTEST_FAIL_ON_WARNING: "0"
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-interactive-baci-BruteForce-gcc-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_bruteforce_gcc.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        GIT_STRATEGY: fetch
    before_script:
        - module load comp/gcc/5.3.0
    tags:
        - lnm-bruteforce-gcc-interactive
    rules:
        - if: '$GITLAB_INTERACTIVE_MODE == "1" && $GITLAB_INTERACTIVE_MACHINE == "lnm_bruteforce_gcc"'
          when: always

lnm-buildtest_daily_deep:
    <<: *buildtest_daily
    variables:
        TEST_TAG: ""
        CTEST_FAIL_ON_WARNING: "0"
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Deep-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_deep.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-nightly-build-deep
    only:
        variables:
            - $GITLAB_SCHEDULER_LNM_DEEP == "1"

lnm-buildtest-deep_interactive:
    <<: *buildtest_interactive
    variables:
        TEST_TAG: ""
        CTEST_FAIL_ON_WARNING: "0"
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-interactive-baci-Deep-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_deep.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        GIT_STRATEGY: fetch
    tags:
        - lnm-deep-interactive
    rules:
        - if: '$GITLAB_INTERACTIVE_MODE == "1" && $GITLAB_INTERACTIVE_MACHINE == "lnm_deep"'
          when: always

lnm-buildtest_daily_schmarrn:
    <<: *buildtest_daily
    variables:
        TEST_TAG: ""
        CTEST_FAIL_ON_WARNING: "0"
        CTEST_MAKE: "make -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015-Kaiser-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "schmarrn_Q12015_gcc48_ACML_ompi162.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-nightly-build-schmarrn
    only:
        variables:
            - $GITLAB_SCHEDULER_LNM_SCHMARRN == "1"

lnm-buildtest-schmarrn_interactive:
    <<: *buildtest_interactive
    variables:
        TEST_TAG: ""
        CTEST_FAIL_ON_WARNING: "0"
        CTEST_MAKE: "make -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-interactive-baci-Q1-2015-Kaiser-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "schmarrn_Q12015_gcc48_ACML_ompi162.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        GIT_STRATEGY: fetch
    tags:
        - lnm-schmarrn-interactive
    rules:
        - if: '$GITLAB_INTERACTIVE_MODE == "1" && $GITLAB_INTERACTIVE_MACHINE == "lnm_schmarrn"'
          when: always

lnm-buildtest_daily_debug:
    <<: *buildtest_daily_debug
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "LnM-Workstation DEBUG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-debug-nightly-full

lnm-doxygen-web:
    <<: *doxygen_web
    variables:
        CTEST_MAKE: "make documentation"
        CTEST_BUILD_NAME_GITLAB: "Doxygen-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-user-full

lnm-doxygen:
    <<: *doxygen
    variables:
        CTEST_MAKE: "make documentation"
        CTEST_BUILD_NAME_GITLAB: "Doxygen-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "lnm_workstation.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        # Path on testing machine where doxygen will be copied to.
        DOXYGEN_PATH: "/home/gitlab-runner/."
    tags:
        - lnm-nightly-doxygen
